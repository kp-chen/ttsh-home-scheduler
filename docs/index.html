<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTSH@Home Nurse Scheduling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        #map { height: 400px; width: 100%; border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="max-w-7xl mx-auto px-4">
            <h1 class="text-3xl font-bold">üè• TTSH@Home Nurse Scheduling System</h1>
            <p class="text-blue-100 mt-2">Mobile Inpatient Care - Automated Route Optimization</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üì§ Step 1: Upload Patient Data</h2>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors" id="dropZone">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">
                <div class="text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="mt-2">Drop Excel file here or <button onclick="document.getElementById('fileInput').click()" class="text-blue-600 underline">browse</button></p>
                    <p class="text-sm text-gray-400 mt-1">Supports .xlsx, .xls, .csv</p>
                </div>
            </div>
            
            <button onclick="useSampleData()" class="mt-4 text-blue-600 hover:text-blue-800 text-sm">
                üìù Use sample data instead
            </button>
        </div>

        <!-- Configuration Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6" id="configSection" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">‚öôÔ∏è Step 2: Configure Nurses</h2>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nurse 1 Name</label>
                    <input type="text" id="nurse1Name" value="Nurse Alice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nurse 2 Name</label>
                    <input type="text" id="nurse2Name" value="Nurse Betty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
            </div>
            
            <button onclick="runScheduler()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                üöÄ Generate Schedule
            </button>
        </div>

        <!-- Data Preview -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6" id="previewSection" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Data Preview</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="dataTable">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tableBody"></tbody>
                </table>
            </div>
            <p class="text-sm text-gray-500 mt-2" id="dataCount"></p>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6" id="resultsSection" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Generated Schedule</h2>
            
            <!-- Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-blue-600" id="metricVisits">0</p>
                    <p class="text-sm text-gray-600">Total Visits</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-green-600" id="metricTravel">0</p>
                    <p class="text-sm text-gray-600">Travel Time (min)</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-yellow-600" id="metricUnassigned">0</p>
                    <p class="text-sm text-gray-600">Unassigned</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-purple-600" id="metricNurses">2</p>
                    <p class="text-sm text-gray-600">Nurses</p>
                </div>
            </div>

            <!-- Schedule Tables -->
            <div id="scheduleResults"></div>

            <!-- Map -->
            <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3">üó∫Ô∏è Route Map</h3>
            <div id="map"></div>

            <!-- Export -->
            <div class="mt-6">
                <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    üì• Download Schedule (Excel)
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p>TTSH Mobile Inpatient Care at Home - Scheduling System v1.0</p>
            <p class="text-sm mt-2">Built with ‚ù§Ô∏è for better healthcare delivery</p>
        </div>
    </footer>

    <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    const CONFIG = {
        WORK_START: 510,      // 8:30 AM in minutes
        WORK_END: 990,        // 4:30 PM in minutes
        BLOOD_DRAW_LATEST: 600, // 10:00 AM
        MAX_VISITS_PER_NURSE: 6,
        DEFAULT_TRAVEL_TIME: 20,
        SAME_ZONE_TRAVEL_TIME: 15,
        HOSPITAL_LAT: 1.3214,
        HOSPITAL_LNG: 103.8456,
        ZONE_MAPPING: {
            "North": ["50", "51", "52", "53", "54", "55", "56", "57", "72", "73"],
            "South": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10"],
            "East": ["38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49"],
            "West": ["60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71"],
            "Central": ["11", "12", "13", "14", "15", "16", "17", "18", "19", "20", 
                       "21", "22", "23", "24", "25", "26", "27", "28", "29", "30",
                       "31", "32", "33", "34", "35", "36", "37"]
        }
    };

    // ============================================================
    // STATE
    // ============================================================
    let patientData = [];
    let scheduledVisits = [];
    let map = null;

    // ============================================================
    // FILE HANDLING
    // ============================================================
    document.getElementById('fileInput').addEventListener('change', handleFile);
    
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        handleFile({ target: { files: e.dataTransfer.files } });
    });

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            patientData = XLSX.utils.sheet_to_json(firstSheet);
            displayData();
        };
        reader.readAsArrayBuffer(file);
    }

    function useSampleData() {
        patientData = [
            { Name: "Tan AH", Location: "Blk 123 Ang Mo Kio Ave 4 S(560123)", "Home Visit task/time": "IV ABx 8 hrly", "Session 2 task/time": "IV ABx 8 hrly (PM)", Priority: "Normal", Language: "Mandarin" },
            { Name: "Lim BK", Location: "Blk 456 Toa Payoh Lor 1 S(310456)", "Home Visit task/time": "Blood taking", "Session 2 task/time": "", Priority: "Normal", Language: "English" },
            { Name: "Wong CL", Location: "Blk 789 Hougang Ave 5 S(530789)", "Home Visit task/time": "IV ABx", "Session 2 task/time": "", Priority: "Normal", Language: "English" },
            { Name: "Chen DM", Location: "Blk 234 Bishan St 22 S(570234)", "Home Visit task/time": "Wound dressing", "Session 2 task/time": "", Priority: "Normal", Language: "Mandarin" },
            { Name: "Lee EF", Location: "Blk 567 Woodlands Dr 14 S(730567)", "Home Visit task/time": "Others (Priority) 10:00", "Session 2 task/time": "", Priority: "Priority", Language: "Malay" },
            { Name: "Ng GH", Location: "Blk 890 Ang Mo Kio Ave 10 S(560890)", "Home Visit task/time": "IV ABx", "Session 2 task/time": "", Priority: "Normal", Language: "English" }
        ];
        displayData();
    }

    function displayData() {
        document.getElementById('configSection').style.display = 'block';
        document.getElementById('previewSection').style.display = 'block';
        
        const header = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        
        const cols = Object.keys(patientData[0]);
        header.innerHTML = cols.map(col => `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${col}</th>`).join('');
        
        body.innerHTML = patientData.slice(0, 10).map(row => 
            `<tr>${cols.map(col => `<td class="px-4 py-3 text-sm text-gray-900">${row[col] || ''}</td>`).join('')}</tr>`
        ).join('');
        
        document.getElementById('dataCount').textContent = `Showing ${Math.min(10, patientData.length)} of ${patientData.length} patients`;
    }

    // ============================================================
    // SCHEDULER
    // ============================================================
    function minutesToTime(minutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    function extractPostalCode(address) {
        const match = address.match(/S\((\d{6})\)/) || address.match(/\b(\d{6})\b/);
        return match ? match[1] : '000000';
    }

    function determineZone(postalCode) {
        const prefix = postalCode.substring(0, 2);
        for (const [zone, prefixes] of Object.entries(CONFIG.ZONE_MAPPING)) {
            if (prefixes.includes(prefix)) return zone;
        }
        return 'Central';
    }

    function identifyProcedure(task) {
        const taskLower = task.toLowerCase();
        if (taskLower.includes('iv abx 8 hrly')) return { type: 'IV_8HR', duration: 45, needsPair: true };
        if (taskLower.includes('blood taking') || taskLower.includes('blood draw')) return { type: 'BLOOD', duration: 20, needsPair: false };
        if (taskLower.includes('iv abx')) return { type: 'IV', duration: 45, needsPair: false };
        if (taskLower.includes('wound')) return { type: 'WOUND', duration: 30, needsPair: false };
        return { type: 'OTHER', duration: 30, needsPair: false };
    }

    function parsePatients() {
        const patients = [];
        const visits = [];

        patientData.forEach((row, idx) => {
            const postalCode = extractPostalCode(row.Location || '');
            const zone = determineZone(postalCode);
            
            const patient = {
                id: `P${idx.toString().padStart(3, '0')}`,
                name: row.Name || `Patient ${idx}`,
                address: row.Location || '',
                postalCode: postalCode,
                zone: zone,
                language: row.Language || 'English'
            };
            patients.push(patient);

            const task = row['Home Visit task/time'] || '';
            if (task) {
                const proc = identifyProcedure(task);
                let earliest, latest;

                if (proc.type === 'BLOOD') {
                    earliest = CONFIG.WORK_START;
                    latest = CONFIG.BLOOD_DRAW_LATEST;
                } else if (proc.type === 'IV_8HR') {
                    earliest = CONFIG.WORK_START;
                    latest = 600; // 10 AM
                } else {
                    earliest = CONFIG.WORK_START;
                    latest = 660; // 11 AM (before lunch)
                }

                visits.push({
                    id: `V${idx}_1`,
                    patient: patient,
                    procedure: proc.type,
                    session: 'AM',
                    earliest: earliest,
                    latest: latest,
                    duration: proc.duration,
                    priority: row.Priority === 'Priority' ? 1 : 3
                });

                if (proc.needsPair) {
                    visits.push({
                        id: `V${idx}_2`,
                        patient: patient,
                        procedure: proc.type,
                        session: 'PM',
                        earliest: 960, // 4 PM
                        latest: CONFIG.WORK_END,
                        duration: proc.duration,
                        priority: 3,
                        continuityGroup: `CG${idx}`
                    });
                    visits[visits.length - 2].continuityGroup = `CG${idx}`;
                }
            }
        });

        return { patients, visits };
    }

    function runScheduler() {
        const { patients, visits } = parsePatients();
        const nurses = [
            { id: 'N001', name: document.getElementById('nurse1Name').value, visits: { AM: [], PM: [] } },
            { id: 'N002', name: document.getElementById('nurse2Name').value, visits: { AM: [], PM: [] } }
        ];

        scheduledVisits = [];
        const sortedVisits = [...visits].sort((a, b) => a.priority - b.priority || a.earliest - b.earliest);

        sortedVisits.forEach(visit => {
            for (const nurse of nurses) {
                const session = visit.session;
                if (nurse.visits[session].length >= 3) continue;

                // Check continuity
                if (visit.continuityGroup) {
                    const related = scheduledVisits.find(sv => 
                        sv.visit.continuityGroup === visit.continuityGroup && sv.nurse.id !== nurse.id
                    );
                    if (related) continue;
                }

                let scheduledTime;
                let travelTime;

                if (nurse.visits[session].length === 0) {
                    scheduledTime = visit.earliest;
                    travelTime = 30; // From hospital
                } else {
                    const lastVisit = nurse.visits[session][nurse.visits[session].length - 1];
                    travelTime = lastVisit.visit.patient.zone === visit.patient.zone ? 
                        CONFIG.SAME_ZONE_TRAVEL_TIME : CONFIG.DEFAULT_TRAVEL_TIME;
                    scheduledTime = lastVisit.scheduledTime + lastVisit.visit.duration + travelTime;
                }

                scheduledTime = Math.max(scheduledTime, visit.earliest);

                if (scheduledTime <= visit.latest) {
                    const sv = {
                        visit: visit,
                        nurse: nurse,
                        scheduledTime: scheduledTime,
                        travelTime: travelTime,
                        sequence: nurse.visits[session].length
                    };
                    scheduledVisits.push(sv);
                    nurse.visits[session].push(sv);
                    break;
                }
            }
        });

        displayResults(nurses, visits);
    }

    function displayResults(nurses, allVisits) {
        document.getElementById('resultsSection').style.display = 'block';
        
        // Metrics
        const totalTravel = scheduledVisits.reduce((sum, sv) => sum + sv.travelTime, 0);
        document.getElementById('metricVisits').textContent = scheduledVisits.length;
        document.getElementById('metricTravel').textContent = totalTravel;
        document.getElementById('metricUnassigned').textContent = allVisits.length - scheduledVisits.length;
        document.getElementById('metricNurses').textContent = nurses.length;

        // Schedule tables
        let html = '';
        nurses.forEach(nurse => {
            const nurseVisits = scheduledVisits.filter(sv => sv.nurse.id === nurse.id)
                .sort((a, b) => a.scheduledTime - b.scheduledTime);
            
            html += `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">üë©‚Äç‚öïÔ∏è ${nurse.name} (${nurseVisits.length} visits)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Seq</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Procedure</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Travel</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${nurseVisits.map(sv => `
                                    <tr>
                                        <td class="px-4 py-2 text-sm">${sv.sequence + 1}</td>
                                        <td class="px-4 py-2 text-sm font-medium">${minutesToTime(sv.scheduledTime)}</td>
                                        <td class="px-4 py-2 text-sm">${sv.visit.patient.name}</td>
                                        <td class="px-4 py-2 text-sm">${sv.visit.procedure}</td>
                                        <td class="px-4 py-2 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">${sv.visit.patient.zone}</span></td>
                                        <td class="px-4 py-2 text-sm">${sv.travelTime} min</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        document.getElementById('scheduleResults').innerHTML = html;

        // Map
        if (map) map.remove();
        map = L.map('map').setView([CONFIG.HOSPITAL_LAT, CONFIG.HOSPITAL_LNG], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, CartoDB'
        }).addTo(map);

        // Hospital marker
        L.marker([CONFIG.HOSPITAL_LAT, CONFIG.HOSPITAL_LNG], {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background: red; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            })
        }).addTo(map).bindPopup('üè• TTSH (Start/End)');

        const colors = ['blue', 'green'];
        const zoneCoords = {
            'North': [1.42, 103.82],
            'South': [1.27, 103.82],
            'East': [1.35, 103.94],
            'West': [1.35, 103.70],
            'Central': [1.35, 103.85]
        };

        nurses.forEach((nurse, idx) => {
            const nurseVisits = scheduledVisits.filter(sv => sv.nurse.id === nurse.id)
                .sort((a, b) => a.scheduledTime - b.scheduledTime);
            
            const routeCoords = [[CONFIG.HOSPITAL_LAT, CONFIG.HOSPITAL_LNG]];

            nurseVisits.forEach(sv => {
                const base = zoneCoords[sv.visit.patient.zone] || zoneCoords['Central'];
                const lat = base[0] + (Math.random() - 0.5) * 0.04;
                const lng = base[1] + (Math.random() - 0.5) * 0.04;
                routeCoords.push([lat, lng]);

                L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: colors[idx],
                    color: 'white',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`
                    <b>${sv.visit.patient.name}</b><br>
                    Time: ${minutesToTime(sv.scheduledTime)}<br>
                    Nurse: ${nurse.name}
                `);
            });

            routeCoords.push([CONFIG.HOSPITAL_LAT, CONFIG.HOSPITAL_LNG]);
            L.polyline(routeCoords, { color: colors[idx], weight: 3, opacity: 0.7 }).addTo(map);
        });
    }

    function exportToExcel() {
        const data = scheduledVisits.map(sv => ({
            Nurse: sv.nurse.name,
            Sequence: sv.sequence + 1,
            'Scheduled Time': minutesToTime(sv.scheduledTime),
            'Patient Name': sv.visit.patient.name,
            Location: sv.visit.patient.address,
            Zone: sv.visit.patient.zone,
            Procedure: sv.visit.procedure,
            Session: sv.visit.session,
            'Travel Time (min)': sv.travelTime
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Schedule');
        XLSX.writeFile(wb, `schedule_${new Date().toISOString().slice(0, 10)}.xlsx`);
    }
    </script>
</body>
</html>
